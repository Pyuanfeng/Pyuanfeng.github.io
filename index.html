<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”µç¦»è¾å°„å®‰å…¨é˜²æŠ¤ - åœ¨çº¿ç­”é¢˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; --card: #fff; --text: #1e293b; --text-light: #64748b; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }
        .header { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; padding: 20px 16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.15); }
        .header h1 { font-size: 1.25rem; font-weight: 600; text-align: center; }
        .header-stats { display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.875rem; }
        .header-stats span { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
        .tab { padding: 10px 20px; border: none; background: var(--card); border-radius: 8px; cursor: pointer; font-size: 0.9rem; white-space: nowrap; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab.active { background: var(--primary); color: white; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .q-badge { display: inline-block; padding: 4px 12px; background: var(--primary); color: white; border-radius: 20px; font-size: 0.8rem; font-weight: 500; margin-bottom: 12px; }
        .q-badge.multiple { background: #7c3aed; }
        .q-category { display: inline-block; margin-left: 8px; padding: 4px 12px; background: #f1f5f9; color: var(--text-light); border-radius: 20px; font-size: 0.75rem; }
        .question-text { font-size: 1rem; font-weight: 500; margin-bottom: 20px; line-height: 1.8; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option { display: flex; align-items: flex-start; padding: 14px 16px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; background: var(--card); }
        .option:hover { border-color: var(--primary); background: #f0f7ff; }
        .option.selected { border-color: var(--primary); background: #eff6ff; }
        .option.correct { border-color: var(--success); background: #d1fae5; }
        .option.wrong { border-color: var(--danger); background: #fee2e2; }
        .option.disabled { cursor: not-allowed; opacity: 0.7; }
        .option-letter { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: var(--border); border-radius: 6px; font-weight: 600; font-size: 0.875rem; margin-right: 12px; flex-shrink: 0; }
        .option.selected .option-letter { background: var(--primary); color: white; }
        .option.correct .option-letter { background: var(--success); color: white; }
        .option.wrong .option-letter { background: var(--danger); color: white; }
        .option-content { flex: 1; font-size: 0.95rem; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
        .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 16px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #7c3aed); transition: width 0.3s ease; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat-item { background: var(--card); padding: 16px; border-radius: 10px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.875rem; color: var(--text-light); margin-top: 4px; }
        .stat-item.success .stat-value { color: var(--success); }
        .stat-item.danger .stat-value { color: var(--danger); }
        .mode-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .mode-card { background: var(--card); padding: 24px 16px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s; }
        .mode-card:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .mode-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .mode-title { font-weight: 600; margin-bottom: 8px; }
        .mode-desc { font-size: 0.875rem; color: var(--text-light); }
        .q-nav { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
        .q-num { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.875rem; cursor: pointer; background: var(--card); border: 1px solid var(--border); transition: all 0.2s; }
        .q-num.current { background: var(--primary); color: white; border-color: var(--primary); }
        .q-num.answered { background: #dbeafe; border-color: #93c5fd; }
        .q-num.correct { background: #d1fae5; border-color: #6ee7b7; }
        .q-num.wrong { background: #fee2e2; border-color: #fca5a5; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--text); color: white; padding: 12px 24px; border-radius: 8px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; }
        .home-banner { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; padding: 40px 24px; border-radius: 16px; text-align: center; margin-bottom: 24px; }
        .home-banner h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .answer-result { margin-top: 20px; padding: 16px; border-radius: 10px; display: none; }
        .answer-result.show { display: block; }
        .answer-result.correct { background: #d1fae5; color: #065f46; }
        .answer-result.wrong { background: #fee2e2; color: #991b1b; }
        .answer-text { font-weight: 600; margin-bottom: 8px; }
        .loading { text-align: center; padding: 60px 20px; }
        .spinner { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .type-filter { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
        .type-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--card); border-radius: 20px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .type-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .set-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--card); border-radius: 20px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .set-btn.active { background: var(--success); color: white; border-color: var(--success); }
        .cat-btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--card); border-radius: 20px; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .cat-btn.active { background: #f59e0b; color: white; border-color: #f59e0b; }
        #categoryCard.hidden { display: none; }
        @media (min-width: 768px) { .container { padding: 24px; } .header h1 { font-size: 1.5rem; } .question-text { font-size: 1.1rem; } .mode-grid { grid-template-columns: repeat(4, 1fr); } .stats-grid { grid-template-columns: repeat(4, 1fr); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ç”µç¦»è¾å°„å®‰å…¨é˜²æŠ¤</h1>
        <div class="header-stats">
            <span>å•é€‰é¢˜: <strong id="singleCount">0</strong></span>
            <span>å¤šé€‰é¢˜: <strong id="multipleCount">0</strong></span>
        </div>
    </div>
    <div class="container">
        <div id="loadingScreen" class="loading"><div class="spinner"></div><p>æ­£åœ¨åŠ è½½é¢˜åº“...</p></div>
        <div id="homeScreen" class="hidden">
            <div class="home-banner"><h2>ç”µç¦»è¾å°„å®‰å…¨é˜²æŠ¤é¢˜åº“</h2><p>åœ¨çº¿ç»ƒä¹  / æ¨¡æ‹Ÿæµ‹è¯• / é”™é¢˜å¤ä¹ </p></div>
            <div class="card"><h4 style="margin-bottom: 12px;">é€‰æ‹©é¢˜åº“</h4>
                <div class="type-filter" id="setFilter">
                    <button class="set-btn active" data-set="all" onclick="selectSet('all')">å…¨éƒ¨é¢˜åº“</button>
                    <button class="set-btn" data-set="allQuestions" onclick="selectSet('allQuestions')">è¾å°„å®‰å…¨ç®¡ç†</button>
                    <button class="set-btn" data-set="questions_fangzhi" onclick="selectSet('questions_fangzhi')">æ”¾å°„æ²»ç–—</button>
                    <button class="set-btn" data-set="questions_xshezhen" onclick="selectSet('questions_xshezhen')">åŒ»ç”¨Xå°„çº¿è¯Šæ–­</button>
                    <button class="set-btn" data-set="questions_keyan" onclick="selectSet('questions_keyan')">ç§‘ç ”ç”Ÿäº§åŠå…¶ä»–</button>
                </div>
                <div style="font-size: 0.875rem; color: var(--text-light);">å½“å‰é¢˜åº“: <span id="currentSetName">å…¨éƒ¨é¢˜åº“</span>ï¼Œå…± <span id="setQuestionCount">0</span> é¢˜</div>
            </div>
            <div class="card" id="categoryCard"><h4 style="margin-bottom: 12px;">ç« èŠ‚ç­›é€‰</h4>
                <div class="type-filter" id="categoryFilter">
                    <button class="cat-btn active" data-cat="all" onclick="selectCategory('all')">å…¨éƒ¨ç« èŠ‚</button>
                </div>
                <div style="font-size: 0.875rem; color: var(--text-light);">å½“å‰ç« èŠ‚: <span id="currentCatName">å…¨éƒ¨ç« èŠ‚</span>ï¼Œå…± <span id="catQuestionCount">0</span> é¢˜</div>
            </div>
            <div class="card"><h4 style="margin-bottom: 12px;">é¢˜å‹ç­›é€‰</h4>
                <div class="type-filter">
                    <button class="type-btn active" onclick="setTypeFilter('all')">å…¨éƒ¨é¢˜å‹</button>
                    <button class="type-btn" onclick="setTypeFilter('å•é€‰')">å•é€‰é¢˜</button>
                    <button class="type-btn" onclick="setTypeFilter('å¤šé€‰')">å¤šé€‰é¢˜</button>
                </div>
                <div style="font-size: 0.875rem; color: var(--text-light);">å½“å‰æ˜¾ç¤º: <span id="filterCount">0</span> é¢˜</div>
            </div>
            <div class="card"><h3 style="margin-bottom: 16px;">é€‰æ‹©ç­”é¢˜æ¨¡å¼</h3>
                <div class="mode-grid">
                    <div class="mode-card" onclick="startPractice('all')"><div class="mode-icon">ğŸ“š</div><div class="mode-title">å…¨éƒ¨ç»ƒä¹ </div><div class="mode-desc">æŒ‰é¡ºåºç»ƒä¹ æ‰€æœ‰é¢˜ç›®</div></div>
                    <div class="mode-card" onclick="startPractice('random')"><div class="mode-icon">ğŸ²</div><div class="mode-title">éšæœºç»ƒä¹ </div><div class="mode-desc">éšæœºæŠ½å–é¢˜ç›®ç»ƒä¹ </div></div>
                    <div class="mode-card" onclick="startPractice('wrong')"><div class="mode-icon">ğŸ“</div><div class="mode-title">é”™é¢˜å¤ä¹ </div><div class="mode-desc">ä¸“é—¨ç»ƒä¹ åšé”™çš„é¢˜ç›®</div></div>
                    <div class="mode-card" onclick="startPractice('exam')"><div class="mode-icon">ğŸ“‹</div><div class="mode-title">æ¨¡æ‹Ÿè€ƒè¯•</div><div class="mode-desc">éšæœºæŠ½å–50é¢˜æ¨¡æ‹Ÿæµ‹è¯•</div></div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">æ€»é¢˜æ•°</div></div>
                <div class="stat-item success"><div class="stat-value" id="statCorrect">0</div><div class="stat-label">æ­£ç¡®æ•°</div></div>
                <div class="stat-item danger"><div class="stat-value" id="statWrong">0</div><div class="stat-label">é”™è¯¯æ•°</div></div>
                <div class="stat-item"><div class="stat-value" id="statRate">0%</div><div class="stat-label">æ­£ç¡®ç‡</div></div>
            </div>
        </div>
        <div id="quizScreen" class="hidden">
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('current')" id="tabCurrent">å½“å‰é¢˜</button>
                <button class="tab" onclick="switchTab('all')" id="tabAll">é¢˜åº“</button>
                <button class="tab" onclick="switchTab('result')" id="tabResult">ç»“æœ</button>
                <button class="tab" onclick="goHome()" id="tabHome">è¿”å›</button>
            </div>
            <div id="questionPanel">
                <div class="card">
                    <div><span class="q-badge" id="qBadge">å•é€‰é¢˜</span><span class="q-category" id="qCategory"></span></div>
                    <div class="question-text" id="questionText"></div>
                    <div class="options" id="optionsContainer"></div>
                    <div class="answer-result" id="answerResult"><div class="answer-text" id="answerText"></div></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" id="prevBtn" onclick="prevQuestion()">ä¸Šä¸€é¢˜</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()">ç¡®è®¤ç­”æ¡ˆ</button>
                    <button class="btn btn-success" id="nextBtn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
            <div id="qNavPanel" class="card hidden"><h4 style="margin-bottom: 12px;">é¢˜ç›®å¯¼èˆª</h4><div class="q-nav" id="qNav"></div></div>
            <div id="resultPanel" class="hidden">
                <div class="card" style="text-align: center; padding: 30px;">
                    <div style="font-size: 4rem; margin-bottom: 16px;" id="resultEmoji">ğŸ‰</div>
                    <h2 style="margin-bottom: 8px;" id="resultTitle">æµ‹è¯•å®Œæˆ</h2>
                    <p style="color: var(--text-light); margin-bottom: 24px;" id="resultDesc"></p>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-value" id="resultTotal">0</div><div class="stat-label">æ€»é¢˜æ•°</div></div>
                    <div class="stat-item success"><div class="stat-value" id="resultCorrect">0</div><div class="stat-label">æ­£ç¡®æ•°</div></div>
                    <div class="stat-item danger"><div class="stat-value" id="resultWrong">0</div><div class="stat-label">é”™è¯¯æ•°</div></div>
                    <div class="stat-item"><div class="stat-value" id="resultRate">0%</div><div class="stat-label">æ­£ç¡®ç‡</div></div>
                </div>
                <div class="btn-group" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="restartQuiz()">é‡æ–°å¼€å§‹</button>
                    <button class="btn btn-outline" onclick="goHome()">è¿”å›é¦–é¡µ</button>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script src="questions.js"></script>
    <script src="æ”¾å°„æ²»ç–—.js"></script>
    <script src="åŒ»ç”¨Xå°„çº¿è¯Šæ–­ä¸ä»‹å…¥æ”¾å°„å­¦.js"></script>
    <script src="ç§‘ç ”ã€ç”Ÿäº§åŠå…¶ä»–.js"></script>
    <script>
    var filteredQuestions = [];
    var currentQuestions = [];
    var currentIndex = 0;
    var selectedAnswers = {};
    var quizMode = 'all';
    var currentTypeFilter = 'all';
    var currentSet = 'all';
    window.currentCategory = 'all';

    // é¢˜åº“é…ç½®
    var questionSets = {
        'all': { name: 'å…¨éƒ¨é¢˜åº“', data: null },
        'allQuestions': { name: 'è¾å°„å®‰å…¨ç®¡ç†', data: null },
        'questions_fangzhi': { name: 'æ”¾å°„æ²»ç–—', data: null },
        'questions_xshezhen': { name: 'åŒ»ç”¨Xå°„çº¿è¯Šæ–­', data: null },
        'questions_keyan': { name: 'ç§‘ç ”ç”Ÿäº§åŠå…¶ä»–', data: null }
    };

    document.addEventListener('DOMContentLoaded', function() {
        // åˆå§‹åŒ–å„é¢˜åº“æ•°æ®
        Object.keys(questionSets).forEach(function(key) {
            if (key !== 'all' && window[key]) {
                questionSets[key].data = window[key];
                // é‡æ–°ç¼–å·
                questionSets[key].data.forEach(function(q, idx) { q.id = idx + 1; });
            }
        });

        loadWrongAnswers();
        selectSet('all');
        updateStats();
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('homeScreen').classList.remove('hidden');
    });

    function selectSet(setKey) {
        currentSet = setKey;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.set-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if (btn.dataset.set === setKey) btn.classList.add('active');
        });

        // æ›´æ–°æ˜¾ç¤º
        var setInfo = questionSets[setKey];
        document.getElementById('currentSetName').textContent = setInfo.name;

        // è®¡ç®—é¢˜æ•°
        var totalQuestions;
        if (setKey === 'all') {
            totalQuestions = 0;
            Object.keys(questionSets).forEach(function(key) {
                if (key !== 'all' && questionSets[key].data) {
                    totalQuestions += questionSets[key].data.length;
                }
            });
        } else {
            totalQuestions = setInfo.data ? setInfo.data.length : 0;
        }
        document.getElementById('setQuestionCount').textContent = totalQuestions;

        // é‡ç½®ç­›é€‰
        setTypeFilter('all');
        // ç”Ÿæˆç« èŠ‚æŒ‰é’®
        buildCategoryButtons();
    }

    function buildCategoryButtons() {
        var baseQuestions = getCurrentQuestions();
        var categories = {};
        baseQuestions.forEach(function(q) {
            var cat = q.category || 'æœªåˆ†ç±»';
            if (!categories[cat]) categories[cat] = 0;
            categories[cat]++;
        });

        var catFilter = document.getElementById('categoryFilter');
        var catCard = document.getElementById('categoryCard');
        var catCount = Object.keys(categories).length;

        if (catCount <= 1) {
            catCard.classList.add('hidden');
        } else {
            catCard.classList.remove('hidden');
            catFilter.innerHTML = '<button class="cat-btn active" data-cat="all" onclick="selectCategory(\'all\')">å…¨éƒ¨ç« èŠ‚</button>';
            Object.keys(categories).forEach(function(cat) {
                var btn = document.createElement('button');
                btn.className = 'cat-btn';
                btn.dataset.cat = cat;
                btn.textContent = cat + ' (' + categories[cat] + ')';
                btn.onclick = function() { selectCategory(cat); };
                catFilter.appendChild(btn);
            });
        }
        selectCategory('all');
    }

    function selectCategory(catKey) {
        window.currentCategory = catKey;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.cat-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if ((catKey === 'all' && btn.dataset.cat === 'all') ||
                (btn.dataset.cat === catKey)) {
                btn.classList.add('active');
            }
        });

        // æ›´æ–°æ˜¾ç¤º
        var catName = catKey === 'all' ? 'å…¨éƒ¨ç« èŠ‚' : catKey;
        document.getElementById('currentCatName').textContent = catName;

        // è®¡ç®—ç« èŠ‚é¢˜æ•°
        var baseQuestions = getCurrentQuestions();
        var catCount;
        if (catKey === 'all') {
            catCount = baseQuestions.length;
        } else {
            catCount = baseQuestions.filter(function(q) { return q.category === catKey; }).length;
        }
        document.getElementById('catQuestionCount').textContent = catCount;

        // æ›´æ–°ç­›é€‰åçš„é¢˜ç›®
        setTypeFilter(currentTypeFilter);
    }

    function loadWrongAnswers() {
        var saved = localStorage.getItem('radiationQuizWrong');
        window.wrongQuestionIds = saved ? new Set(JSON.parse(saved)) : new Set();
    }

    function saveWrongAnswers() {
        localStorage.setItem('radiationQuizWrong', JSON.stringify(Array.from(window.wrongQuestionIds)));
    }

    function getCurrentQuestions() {
        if (currentSet === 'all') {
            var all = [];
            Object.keys(questionSets).forEach(function(key) {
                if (key !== 'all' && questionSets[key].data) {
                    all = all.concat(questionSets[key].data);
                }
            });
            return all;
        } else {
            return questionSets[currentSet].data || [];
        }
    }

    function setTypeFilter(type) {
        currentTypeFilter = type;
        document.querySelectorAll('.type-btn').forEach(function(btn) {
            btn.classList.remove('active');
            if ((type === 'all' && btn.textContent === 'å…¨éƒ¨é¢˜å‹') ||
                (type === 'å•é€‰' && btn.textContent === 'å•é€‰é¢˜') ||
                (type === 'å¤šé€‰' && btn.textContent === 'å¤šé€‰é¢˜')) {
                btn.classList.add('active');
            }
        });

        var baseQuestions = getCurrentQuestions();

        // å…ˆæŒ‰ç« èŠ‚ç­›é€‰
        if (window.currentCategory && window.currentCategory !== 'all') {
            baseQuestions = baseQuestions.filter(function(q) { return q.category === window.currentCategory; });
        }

        if (type === 'all') {
            filteredQuestions = baseQuestions.slice();
        } else {
            filteredQuestions = baseQuestions.filter(function(q) { return q.type === type; });
        }

        document.getElementById('filterCount').textContent = filteredQuestions.length;
        document.getElementById('singleCount').textContent = baseQuestions.filter(function(q) { return q.type === 'å•é€‰'; }).length;
        document.getElementById('multipleCount').textContent = baseQuestions.filter(function(q) { return q.type === 'å¤šé€‰'; }).length;
    }

    function updateStats() {
        setTypeFilter(currentTypeFilter);
        var correct = 0;
        Object.keys(selectedAnswers).forEach(function(key) {
            var idx = parseInt(key.split('_')[1]);
            if (idx < currentQuestions.length) {
                var q = currentQuestions[idx];
                var ans = selectedAnswers[key];
                if (q && normalizeAnswer(ans) === normalizeAnswer(q.answer)) correct++;
            }
        });

        document.getElementById('statTotal').textContent = currentQuestions.length || filteredQuestions.length;
        document.getElementById('statCorrect').textContent = correct;
        document.getElementById('statWrong').textContent = currentQuestions.length - correct;

        var rate = currentQuestions.length > 0 ? Math.round(correct / currentQuestions.length * 100) : 0;
        document.getElementById('statRate').textContent = rate + '%';
    }

    function normalizeAnswer(ans) {
        if (!ans) return '';
        return ans.split(',').sort().join(',');
    }

    function startPractice(mode) {
        quizMode = mode;
        currentIndex = 0;
        selectedAnswers = {};
        currentQuestions = [];
        var baseQuestions = filteredQuestions.length > 0 ? filteredQuestions : getCurrentQuestions();

        switch(mode) {
            case 'all': currentQuestions = baseQuestions.slice(); break;
            case 'random': currentQuestions = baseQuestions.slice().sort(function() { return Math.random() - 0.5; }); break;
            case 'wrong':
                currentQuestions = baseQuestions.filter(function(q) { return window.wrongQuestionIds.has(q.id); });
                if (currentQuestions.length === 0) { showToast('æš‚æ— é”™é¢˜è®°å½•'); return; }
                break;
            case 'exam': currentQuestions = baseQuestions.slice().sort(function() { return Math.random() - 0.5; }).slice(0, Math.min(50, baseQuestions.length)); break;
        }

        if (currentQuestions.length === 0) { showToast('å½“å‰é¢˜åº“æ²¡æœ‰é¢˜ç›®'); return; }

        document.getElementById('homeScreen').classList.add('hidden');
        document.getElementById('quizScreen').classList.remove('hidden');
        renderQuestion();
        renderQuestionNav();
        updateProgress();
    }

    function renderQuestion() {
        if (currentIndex >= currentQuestions.length) { showResult(); return; }

        var q = currentQuestions[currentIndex];
        var isMultiple = q.type === 'å¤šé€‰';
        var badge = document.getElementById('qBadge');
        badge.textContent = isMultiple ? 'å¤šé€‰é¢˜' : 'å•é€‰é¢˜';
        badge.className = 'q-badge' + (isMultiple ? ' multiple' : '');
        document.getElementById('qCategory').textContent = q.category || '';
        document.getElementById('questionText').textContent = (q.id) + '. ' + q.question;

        var container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        var optionLetters = ['A', 'B', 'C', 'D', 'E'];
        var userAnswer = selectedAnswers['q_' + currentIndex] || '';

        optionLetters.forEach(function(letter, idx) {
            var optionText = q.options[idx];
            if (!optionText) return;
            var div = document.createElement('div');
            div.className = 'option';
            div.dataset.letter = letter;
            div.onclick = function() { toggleOption(letter); };
            if (userAnswer.includes(letter)) div.classList.add('selected');
            div.innerHTML = '<span class="option-letter">' + letter + '</span><span class="option-content">' + optionText + '</span>';
            container.appendChild(div);
        });

        document.getElementById('answerResult').classList.remove('show', 'correct', 'wrong');
        document.getElementById('prevBtn').disabled = currentIndex === 0;
        document.getElementById('submitBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'none';
        updateQuestionNav();
    }

    function toggleOption(letter) {
        var q = currentQuestions[currentIndex];
        if (!q) return;
        var key = 'q_' + currentIndex;
        if (!selectedAnswers[key]) selectedAnswers[key] = '';
        var current = selectedAnswers[key];

        if (q.type === 'å¤šé€‰') {
            if (current.includes(letter)) {
                current = current.split(',').filter(function(x) { return x; }).join(',');
            } else {
                var parts = current ? current.split(',') : [];
                parts.push(letter);
                current = parts.join(',');
            }
        } else {
            current = letter;
        }
        selectedAnswers[key] = current;
        renderQuestion();
    }

    function submitAnswer() {
        var q = currentQuestions[currentIndex];
        if (!q) return;
        var key = 'q_' + currentIndex;
        var userAnswer = selectedAnswers[key] || '';
        if (!userAnswer) { showToast('è¯·å…ˆé€‰æ‹©ç­”æ¡ˆ'); return; }

        var normalizedUser = normalizeAnswer(userAnswer);
        var normalizedCorrect = normalizeAnswer(q.answer);
        var isCorrect = normalizedUser === normalizedCorrect;

        document.querySelectorAll('.option').forEach(function(el) {
            var letter = el.dataset.letter;
            el.classList.add('disabled');
            if (q.answer.split(',').includes(letter)) el.classList.add('correct');
            if (userAnswer.split(',').includes(letter) && !isCorrect) el.classList.add('wrong');
        });

        var resultDiv = document.getElementById('answerResult');
        resultDiv.classList.add('show');
        if (isCorrect) {
            resultDiv.classList.add('correct');
            document.getElementById('answerText').textContent = 'å›ç­”æ­£ç¡®ï¼';
        } else {
            resultDiv.classList.add('wrong');
            document.getElementById('answerText').textContent = 'å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆ: ' + q.answer;
        }

        if (!isCorrect) { window.wrongQuestionIds.add(q.id); saveWrongAnswers(); }

        document.getElementById('submitBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'inline-block';
        updateStats();
    }

    function prevQuestion() {
        if (currentIndex > 0) { currentIndex--; renderQuestion(); updateProgress(); }
    }

    function nextQuestion() {
        if (currentIndex < currentQuestions.length - 1) { currentIndex++; renderQuestion(); updateProgress(); }
        else { showResult(); }
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        var tabMap = {current: 'Current', all: 'All', result: 'Result'};
        var el = document.getElementById('tab' + tabMap[tab]);
        if (el) el.classList.add('active');
        document.getElementById('questionPanel').classList.toggle('hidden', tab !== 'current');
        document.getElementById('qNavPanel').classList.toggle('hidden', tab !== 'all');
        document.getElementById('resultPanel').classList.toggle('hidden', tab !== 'result');
        if (tab === 'all') renderQuestionNav();
    }

    function renderQuestionNav() {
        var nav = document.getElementById('qNav');
        nav.innerHTML = '';
        currentQuestions.forEach(function(q, idx) {
            var div = document.createElement('div');
            div.className = 'q-num';
            div.textContent = q.id;
            if (idx === currentIndex) div.classList.add('current');
            var userAnswer = selectedAnswers['q_' + idx];
            if (userAnswer) {
                div.classList.add('answered');
                if (normalizeAnswer(userAnswer) === normalizeAnswer(q.answer)) div.classList.add('correct');
                else div.classList.add('wrong');
            }
            div.onclick = function() { currentIndex = idx; renderQuestion(); updateProgress(); };
            nav.appendChild(div);
        });
    }

    function updateQuestionNav() {
        document.querySelectorAll('.q-num').forEach(function(item, idx) {
            item.classList.toggle('current', idx === currentIndex);
        });
    }

    function updateProgress() {
        var progress = ((currentIndex + 1) / currentQuestions.length) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }

    function showResult() {
        var correct = 0;
        currentQuestions.forEach(function(q, idx) {
            var userAnswer = selectedAnswers['q_' + idx] || '';
            if (normalizeAnswer(userAnswer) === normalizeAnswer(q.answer)) correct++;
        });
        var total = currentQuestions.length;
        var rate = total > 0 ? Math.round(correct / total * 100) : 0;
        document.getElementById('resultTotal').textContent = total;
        document.getElementById('resultCorrect').textContent = correct;
        document.getElementById('resultWrong').textContent = total - correct;
        document.getElementById('resultRate').textContent = rate + '%';

        var emoji = document.getElementById('resultEmoji');
        var title = document.getElementById('resultTitle');
        var desc = document.getElementById('resultDesc');
        if (rate >= 90) { emoji.textContent = 'ğŸŒŸ'; title.textContent = 'å¤ªæ£’äº†ï¼'; desc.textContent = 'æ‚¨å·²ç»æŒæ¡äº†è¿™éƒ¨åˆ†å†…å®¹ï¼'; }
        else if (rate >= 70) { emoji.textContent = 'ğŸ‰'; title.textContent = 'åšå¾—ä¸é”™ï¼'; desc.textContent = 'ç»§ç»­åŠªåŠ›ï¼Œå¯ä»¥æ›´å¥½ï¼'; }
        else if (rate >= 50) { emoji.textContent = 'ğŸ’ª'; title.textContent = 'è¿˜éœ€è¦åŠ æ²¹ï¼'; desc.textContent = 'å»ºè®®å¤šç»ƒä¹ é”™é¢˜ï¼'; }
        else { emoji.textContent = 'ğŸ“š'; title.textContent = 'ç»§ç»­å­¦ä¹ ï¼'; desc.textContent = 'å»ºè®®æŸ¥çœ‹é”™é¢˜è§£æåå†è¯•ï¼'; }
        switchTab('result');
    }

    function restartQuiz() { startPractice(quizMode); }

    function goHome() {
        document.getElementById('homeScreen').classList.remove('hidden');
        document.getElementById('quizScreen').classList.add('hidden');
        switchTab('current');
        updateStats();
    }

    function showToast(message) {
        var toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(function() { toast.classList.remove('show'); }, 2000);
    }
    </script>
</body>
</html>
